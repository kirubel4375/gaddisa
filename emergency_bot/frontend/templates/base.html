{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}{% trans "Emergency Reporting System" %}{% endblock %}</title>
    
    <!-- Telegram Mini App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    
    <style>
        /* Enhanced CSS Variables for Telegram WebApp Theme Support */
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #222222;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #2678b6;
            --tg-theme-button-color: #50a8eb;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f8f9fa;
            --primary-color: #007aff;
            --danger-color: #f44336;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --card-bg-color: white;
            --input-bg-color: white;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Dark mode variables */
        body.dark {
            --tg-theme-bg-color: #17212b;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #708499;
            --tg-theme-link-color: #6ab7ff;
            --tg-theme-button-color: #5288c1;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #232e3c;
            --primary-color: #6ab7ff;
            --danger-color: #ff6b6b;
            --success-color: #51cf66;
            --warning-color: #ffd43b;
            --card-bg-color: #232e3c;
            --input-bg-color: #2a2a2a;
            --border-color: #444444;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }
        
        body {
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Ensure all text elements are visible */
        body.dark h1, body.dark h2, body.dark h3, body.dark h4, body.dark h5, body.dark h6,
        body.dark p, body.dark span, body.dark div, body.dark label {
            color: var(--tg-theme-text-color);
        }
        
        body.dark a {
            color: var(--tg-theme-link-color);
        }
        
        body.dark a:hover {
            color: var(--primary-color);
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% csrf_token %}
    <div id="app" class="container-fluid p-0">
        <div id="content">
            {% block content %}{% endblock %}
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Telegram Mini App Initialization -->
    <script>
        // Initialize Telegram WebApp with error handling
        let tg = null;
        let user = {};
        
        try {
            tg = window.Telegram && window.Telegram.WebApp;
            if (tg) {
                tg.expand();
                
                // Enhanced theme detection and application
                const colorScheme = tg.colorScheme || 'light';
                const themeParams = tg.themeParams || {};
                
                // Apply theme class to body
                document.body.className = colorScheme;
                
                // Update CSS variables with Telegram theme parameters if available
                if (themeParams.bg_color) {
                    document.documentElement.style.setProperty('--tg-theme-bg-color', themeParams.bg_color);
                }
                if (themeParams.text_color) {
                    document.documentElement.style.setProperty('--tg-theme-text-color', themeParams.text_color);
                }
                if (themeParams.hint_color) {
                    document.documentElement.style.setProperty('--tg-theme-hint-color', themeParams.hint_color);
                }
                if (themeParams.link_color) {
                    document.documentElement.style.setProperty('--tg-theme-link-color', themeParams.link_color);
                }
                if (themeParams.button_color) {
                    document.documentElement.style.setProperty('--tg-theme-button-color', themeParams.button_color);
                }
                if (themeParams.button_text_color) {
                    document.documentElement.style.setProperty('--tg-theme-button-text-color', themeParams.button_text_color);
                }
                if (themeParams.secondary_bg_color) {
                    document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', themeParams.secondary_bg_color);
                }
                
                // Store user data
                user = {
                    id: tg.initDataUnsafe?.user?.id || new URLSearchParams(window.location.search).get('user_id'),
                    first_name: tg.initDataUnsafe?.user?.first_name || '',
                    last_name: tg.initDataUnsafe?.user?.last_name || '',
                    username: tg.initDataUnsafe?.user?.username || '',
                    language: tg.initDataUnsafe?.user?.language_code || 'en'
                };
                
                console.log('Telegram WebApp initialized with theme:', colorScheme, 'and params:', themeParams);
            } else {
                // Fallback for testing outside Telegram
                user = {
                    id: new URLSearchParams(window.location.search).get('user_id'),
                    first_name: '',
                    last_name: '',
                    username: '',
                    language: 'en'
                };
                
                // Check for dark mode preference in browser
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    document.body.className = 'dark';
                }
            }
        } catch (error) {
            console.log('Telegram WebApp initialization error:', error);
            // Fallback user data
            user = {
                id: new URLSearchParams(window.location.search).get('user_id'),
                first_name: '',
                last_name: '',
                username: '',
                language: 'en'
            };
            
            // Check for dark mode preference in browser as fallback
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.className = 'dark';
            }
        }

        // Current page language (set by Django)
        const currentLanguage = '{{ LANGUAGE_CODE }}';
        
        // Single DOMContentLoaded event listener to avoid conflicts
        document.addEventListener('DOMContentLoaded', function() {
            // Add user_id and language to all links if not already present
            if (user.id) {
                const currentLang = localStorage.getItem('mini_app_language') || currentLanguage || 'en';
                
                const links = document.querySelectorAll('a');
                links.forEach(link => {
                    try {
                        const url = new URL(link.href, window.location.origin);
                        if (!url.searchParams.has('user_id')) {
                            url.searchParams.set('user_id', user.id);
                        }
                        if (!url.searchParams.has('lang')) {
                            url.searchParams.set('lang', currentLang);
                        }
                        link.href = url.toString();
                    } catch (e) {
                        // Skip invalid links
                        console.log('Skipping invalid link:', link.href);
                    }
                });

                // Authenticate with backend
                verifyTelegramAuth();
            }
        });

        // Function to authenticate with backend (with better error handling)
        function verifyTelegramAuth() {
            if (!user.id) {
                console.log('No user ID available, skipping authentication');
                return;
            }
            
            fetch('/api/accounts/verify/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-ID': user.id.toString(),
                    'X-Telegram-Init-Data': tg.initData || ''
                },
                body: JSON.stringify({
                    user_id: user.id,
                    init_data: tg.initData || ''
                })
            })
            .then(response => {
                if (!response.ok) {
                    console.log('Authentication failed (non-critical)');
                }
                return response.json().catch(() => ({})); // Handle invalid JSON gracefully
            })
            .then(data => {
                console.log('Authentication completed:', data);
            })
            .catch(error => {
                console.log('Authentication error (non-critical):', error);
            });
        }
        
        // Function to close the app
        function closeApp() {
            tg.close();
        }
        
        // Function to show a loading indicator
        function showLoading() {
            tg.MainButton.showProgress();
        }
        
        // Function to hide the loading indicator
        function hideLoading() {
            tg.MainButton.hideProgress();
        }
        
        // Function to show a main button
        function showMainButton(text, callback) {
            tg.MainButton.setText(text);
            tg.MainButton.onClick(callback);
            tg.MainButton.show();
        }
        
        // Function to hide the main button
        function hideMainButton() {
            tg.MainButton.hide();
        }
        
        // Function to send data back to the Telegram bot
        function sendData(data) {
            tg.sendData(JSON.stringify(data));
        }
        
        // Function to show alert
        function showAlert(message) {
            tg.showAlert(message);
        }
        
        // Function to get user's current language preference
        function getUserLanguage() {
            if (!user.id) return Promise.resolve('en');
            
            return apiGet('/api/frontend/get-user-language/')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        return data.language;
                    } else {
                        console.error('Failed to get user language:', data.error);
                        return 'en';
                    }
                })
                .catch(error => {
                    console.error('Error getting user language:', error);
                    return 'en';
                });
        }

        // Debounce mechanism to prevent excessive API calls
        let languageUpdateTimeout = null;
        
        // Function to update user language preference (NO AUTOMATIC RELOAD)
        function updateUserLanguage(languageCode) {
            if (!user.id || !languageCode) return;
            
            // Save to localStorage for mini app persistence
            localStorage.setItem('mini_app_language', languageCode);
            
            // Debounce API calls to prevent excessive requests
            if (languageUpdateTimeout) {
                clearTimeout(languageUpdateTimeout);
            }
            
            languageUpdateTimeout = setTimeout(() => {
                // Save to user profile in background (no reload)
                apiPost('/webapp/api/frontend/update-language/', {
                    language: languageCode,
                    telegram_id: user.id
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Language updated successfully:', languageCode);
                    } else {
                        console.log('Failed to update language:', data.error);
                    }
                })
                .catch(error => {
                    console.log('Error updating language:', error);
                });
            }, 500); // Wait 500ms before sending API request
        }

        // Function to activate language in Django
        function activateLanguage(languageCode) {
            // Use Django's set_language view if available, otherwise reload with language parameter
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/i18n/setlang/';
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            
            const langInput = document.createElement('input');
            langInput.type = 'hidden';
            langInput.name = 'language';
            langInput.value = languageCode;
            
            const nextInput = document.createElement('input');
            nextInput.type = 'hidden';
            nextInput.name = 'next';
            nextInput.value = window.location.pathname + window.location.search;
            
            form.appendChild(csrfInput);
            form.appendChild(langInput);
            form.appendChild(nextInput);
            document.body.appendChild(form);
            form.submit();
        }

        // Simplified language persistence for Telegram mini apps
        // Language preference is handled via localStorage and page reload
    </script>
    
    <!-- Telegram WebApp API Helper: Always send initData for authentication -->
    <script>
        /**
         * Use this function for all API requests to the backend.
         * It automatically includes the Telegram initData for authentication.
         * Example usage:
         *   apiPost('/api/your-endpoint/', { foo: 'bar' })
         *     .then(response => ...)
         */
        function apiPost(url, data) {
            const initData = tg?.initData || '';
            const userId = user.id || new URLSearchParams(window.location.search).get('user_id');
            
            // Add user_id to URL if not already present
            if (userId) {
                try {
                    const urlObj = new URL(url, window.location.origin);
                    if (!urlObj.searchParams.has('user_id')) {
                        urlObj.searchParams.set('user_id', userId);
                        url = urlObj.toString();
                    }
                } catch (e) {
                    console.log('URL parsing error, using original URL:', e);
                }
            }
            
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': initData,
                    'X-User-ID': userId ? userId.toString() : ''
                },
                body: JSON.stringify(data || {})
            });
        }

        /**
         * Use this function for GET requests to the backend.
         * It automatically includes the Telegram user ID in the query parameters.
         * Example usage:
         *   apiGet('/api/your-endpoint/')
         *     .then(response => ...)
         */
        function apiGet(url) {
            const initData = tg?.initData || '';
            const userId = user.id || new URLSearchParams(window.location.search).get('user_id');
            
            // Add user_id to URL if not already present
            if (userId) {
                try {
                    const urlObj = new URL(url, window.location.origin);
                    if (!urlObj.searchParams.has('user_id')) {
                        urlObj.searchParams.set('user_id', userId);
                        url = urlObj.toString();
                    }
                } catch (e) {
                    console.log('URL parsing error, using original URL:', e);
                }
            }
            
            return fetch(url, {
                method: 'GET',
                headers: {
                    'X-Telegram-Init-Data': initData,
                    'X-User-ID': userId ? userId.toString() : ''
                }
            });
        }
    </script>
    
    <!-- Custom JavaScript -->
    {% block extra_js %}{% endblock %}
</body>
</html> 